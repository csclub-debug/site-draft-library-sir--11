<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OPAC (Online Catalog) - Sir M V Library</title>
  <link rel="stylesheet" href="assets/style.css" />
  <style>
    /* Minimal inline safety styles */
    .search-box { display:flex; gap:8px; align-items:center; max-width:900px; }
    #opacSearchInput { flex:1; padding:8px; font-size:15px; }
    #opacSearchBtn { padding:8px 12px; }
    .book-card { margin:6px 0; background:#fff; border-radius:6px; }
    .results-list { display:block; }
    .pagination button { padding:6px 8px; }
    .detail-panel { margin-top:8px; }
    .site-footer .inner { display:flex; flex-direction:column; gap:12px; padding:18px; background:#0f1724; color:#fff; }
    .footer-top { display:flex; gap:12px; align-items:center; justify-content:space-between; }
    .email-btn { display:inline-block; padding:8px 10px; background:#1f6feb; color:#fff; border-radius:6px; text-decoration:none; }
    .result-limit-msg { color:#b91c1c; font-size:13px; margin:8px 0; }
  </style>
</head>
<body>
  <section class="section container" style="padding:18px;">
    <h1 style="margin-top:0">Online Public Access Catalog (OPAC)</h1>

    <div class="search-box" style="margin-bottom: 20px;">
      <input id="opacSearchInput" placeholder="Search by Title, Author, ISBN, Publisher, or Accession Number..." autofocus />
      <button id="opacSearchBtn">Search</button>
    </div>

    <div id="search-message">Loading book data...</div>
    <div id="search-results"></div>
  </section>

  <footer class="site-footer" role="contentinfo">
    <div class="inner">
      <div class="footer-top">
        <div style="display:flex;gap:12px;align-items:center">
          <img src="logo.svg" alt="logo" style="height:44px;width:44px;border-radius:8px" />
          <div>
            <div style="font-weight:700">Sir M V Science College Library</div>
            <div style="font-size:13px;color:#cbd5e1">Library & Informatics Centre</div>
          </div>
        </div>

        <div>
          <a id="footer-email" class="email-btn" href="mailto:library@example.com" aria-label="Email the library">Email Us</a>
        </div>
      </div>

      <div style="color:#9aa4b2;font-size:14px">
        Sir. M.V. Government Science College, Bommanakatte, Bhadravathi - 577302
      </div>
    </div>
  </footer>

  <script>
  (function () {
    'use strict';

    // ---------- CONFIG ----------
    const INDEX_URL = 'content/books_index.json';
    const MAPPING_URL = 'content/accession_to_part.json';
    const PARTS_BASE = 'content/';
    const CMS_DATA_URL = 'content/data.json';
    const PER_PAGE = 30;
    const MIN_SEARCH_CHARS = 3;
    const MAX_RESULTS = 1000; // cap to avoid overload
    // ----------------------------

    const searchInput = document.getElementById('opacSearchInput');
    const searchBtn = document.getElementById('opacSearchBtn');
    const searchResults = document.getElementById('search-results');
    const searchMessage = document.getElementById('search-message');
    const footerEmailLink = document.getElementById('footer-email');

    let lastResults = [];
    let currentPage = 1;
    let worker = null;
    let workerReady = false;
    let mapping = null;
    const fetchedPartsCache = {};

    // -------------- utilities --------------
    function debounce(fn, wait) {
      let t;
      return function (...args) {
        clearTimeout(t);
        t = setTimeout(() => fn.apply(this, args), wait);
      };
    }
    function escapeHtml(s = '') {
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }
    function escapeAttr(s = '') {
      return String(s).replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    }

    // -------------- Footer Email Loader --------------
    async function loadSiteDataAndBindEmail() {
      try {
        const res = await fetch(CMS_DATA_URL, {cache: 'no-cache'});
        const data = await res.json();
        let email = '';

        if (data?.footer?.primary_email) email = data.footer.primary_email.trim();
        else if (data?.primary_email) email = data.primary_email.trim();
        else if (data?.data?.footer?.primary_email) email = data.data.footer.primary_email.trim();

        setFooterEmail(email);
      } catch {
        setFooterEmail('');
      }
    }

    function setFooterEmail(email) {
      if (!footerEmailLink) return;
      if (email) {
        footerEmailLink.href = email.startsWith('mailto:') ? email : 'mailto:' + email;
        footerEmailLink.textContent = email;
        footerEmailLink.setAttribute('aria-label', 'Email ' + email);
      } else {
        footerEmailLink.href = 'mailto:library@example.com';
        footerEmailLink.textContent = 'Email Us';
      }
    }

    // -------------- Web Worker (Search) --------------
    function createSearchWorker() {
      const code = `
        self.index = [];
        const MAX_RESULTS = ${MAX_RESULTS};
        self.onmessage = async function(e) {
          const msg = e.data;
          if (msg.cmd === 'loadIndex') {
            try {
              const url = new URL(msg.url, self.location.origin).href;
              const resp = await fetch(url, {cache:'no-cache'});
              const json = await resp.json();
              self.index = json.books || [];
              for (const b of self.index) {
                if (!b.search) {
                  const s = [b.accession_no,b.title,b.author,b.subject,b.publisher,b.isbn].join(' ');
                  b.search = s.toLowerCase();
                }
              }
              self.postMessage({cmd:'loaded', count:self.index.length});
            } catch (err) {
              self.postMessage({cmd:'error', error:String(err)});
            }
          } else if (msg.cmd === 'search') {
            const q = (msg.query||'').trim().toLowerCase();
            const min = msg.minChars||3;
            if (!q) return self.postMessage({cmd:'results', results:[], capped:false});
            if (q.length<min) return self.postMessage({cmd:'too_short', len:q.length});
            
            let results = [];
            let capped = false;
            for (const b of self.index) {
              if (b.search.includes(q)) {
                results.push(b);
                if (results.length >= MAX_RESULTS) {
                  capped = true;
                  break;
                }
              }
            }
            self.postMessage({cmd:'results', results, query:q, capped});
          }
        };
      `;
      return new Worker(URL.createObjectURL(new Blob([code], {type: 'application/javascript'})));
    }

    function initWorkerAndLoadIndex() {
      worker = createSearchWorker();
      worker.onmessage = (e) => {
        const msg = e.data;
        switch (msg.cmd) {
          case 'loaded':
            workerReady = true;
            searchMessage.textContent = `Book index loaded (${msg.count} records). Enter at least ${MIN_SEARCH_CHARS} characters to search.`;
            break;
          case 'error':
            searchMessage.style.color = 'red';
            searchMessage.textContent = 'Failed to load index: ' + msg.error;
            break;
          case 'too_short':
            searchMessage.textContent = `Please enter at least ${MIN_SEARCH_CHARS} characters to search.`;
            renderResults([]);
            break;
          case 'results':
            lastResults = msg.results || [];
            currentPage = 1;
            renderResults(lastResults, currentPage, msg.capped);
            break;
        }
      };
      worker.postMessage({cmd: 'loadIndex', url: INDEX_URL});
    }

    // -------------- Rendering --------------
    function renderResults(results, page = 1, capped = false) {
      searchResults.innerHTML = '';
      if (!results.length) {
        searchMessage.style.display = 'block';
        searchMessage.textContent = 'No books found matching your search.';
        return;
      }
      searchMessage.style.display = 'none';

      if (capped) {
        const capMsg = document.createElement('div');
        capMsg.className = 'result-limit-msg';
        capMsg.textContent = `Showing first ${MAX_RESULTS} matches only. Please refine your search.`;
        searchResults.appendChild(capMsg);
      }

      const totalPages = Math.ceil(results.length / PER_PAGE);
      const start = (page - 1) * PER_PAGE;
      const end = Math.min(start + PER_PAGE, results.length);
      const slice = results.slice(start, end);

      const container = document.createElement('div');
      container.className = 'results-list';

      for (const b of slice) {
        const c = document.createElement('div');
        c.className = 'book-card';
        c.style.padding = '10px';
        c.style.borderBottom = '1px solid #eee';

        c.innerHTML = `
          <div style="display:flex;justify-content:space-between;gap:12px">
            <div>
              <div style="font-weight:700">${escapeHtml(b.title || 'Untitled')}</div>
              <div style="font-size:13px">Author: ${escapeHtml(b.author || 'N/A')}</div>
              <div style="font-size:13px">Publisher: ${escapeHtml(b.publisher || 'N/A')} ${b.year ? 'â€” ' + escapeHtml(b.year) : ''}</div>
              <div style="font-size:12px;color:#666">Subject: ${escapeHtml(b.subject || 'N/A')}</div>
            </div>
            <div style="text-align:right">
              <div style="font-weight:600">Acc.: ${escapeHtml(b.accession_no || 'N/A')}</div>
              <div style="margin-top:8px">
                <button class="view-btn" data-acc="${escapeAttr(b.accession_no)}">View Details</button>
              </div>
            </div>
          </div>`;
        container.appendChild(c);
      }

      searchResults.appendChild(container);

      if (totalPages > 1) {
        const nav = document.createElement('div');
        nav.className = 'pagination';
        nav.style.marginTop = '12px';
        nav.style.display = 'flex';
        nav.style.gap = '8px';

        const prev = document.createElement('button');
        prev.textContent = 'Previous';
        prev.disabled = page <= 1;
        prev.onclick = () => renderResults(results, page - 1, capped);

        const next = document.createElement('button');
        next.textContent = 'Next';
        next.disabled = page >= totalPages;
        next.onclick = () => renderResults(results, page + 1, capped);

        const info = document.createElement('span');
        info.textContent = `Page ${page} of ${totalPages} â€” ${results.length} results`;

        nav.append(prev, info, next);
        searchResults.appendChild(nav);
      }

      searchResults.querySelectorAll('.view-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const acc = btn.getAttribute('data-acc');
          if (acc) await showFullRecord(acc, btn);
        });
      });
    }

    // -------------- Mapping + Chunk Fetch --------------
    async function ensureMapping() {
      if (mapping) return mapping;
      const res = await fetch(MAPPING_URL, {cache:'no-cache'});
      mapping = await res.json();
      return mapping;
    }

    async function fetchPart(partName) {
      if (!partName) return null;
      if (fetchedPartsCache[partName]) return fetchedPartsCache[partName];
      const res = await fetch(PARTS_BASE + partName);
      const json = await res.json();
      fetchedPartsCache[partName] = json.books || [];
      return fetchedPartsCache[partName];
    }

    async function showFullRecord(accession, btn) {
      const map = await ensureMapping();
      const partName = map[accession];
      if (!partName) return alert('Record not found.');
      const part = await fetchPart(partName);
      const rec = part.find(r => r.accession_no === accession);
      if (!rec) return alert('Record not found in chunk.');

      const card = btn.closest('.book-card');
      card.querySelectorAll('.detail-panel').forEach(n => n.remove());

      const d = document.createElement('div');
      d.className = 'detail-panel';
      d.style.padding = '10px';
      d.style.background = '#fafafa';
      d.style.border = '1px solid #eee';
      d.innerHTML = `
        <div style="font-weight:700">${escapeHtml(rec.title)}</div>
        <div>Author: ${escapeHtml(rec.author || 'N/A')}</div>
        <div>Publisher: ${escapeHtml(rec.publisher || 'N/A')}</div>
        <div>ISBN: ${escapeHtml(rec.isbn || 'N/A')}</div>
        <div>Accession No: ${escapeHtml(rec.accession_no)}</div>
        <pre style="max-height:220px;overflow:auto;background:#fff;padding:8px;border:1px solid #eee;">
${escapeHtml(JSON.stringify(rec, null, 2))}</pre>`;
      card.appendChild(d);
      d.scrollIntoView({behavior:'smooth', block:'center'});
    }

    // -------------- Search Actions --------------
    const doSearch = debounce((q) => {
      if (!workerReady) return searchMessage.textContent = 'Index still loading...';
      worker.postMessage({cmd: 'search', query: q, minChars: MIN_SEARCH_CHARS});
    }, 200);

    searchInput.addEventListener('input', (e) => {
      const q = e.target.value.trim();
      if (!q) {
        searchMessage.textContent = 'Enter a keyword to search.';
        renderResults([]);
        return;
      }
      doSearch(q);
    });
    searchBtn.addEventListener('click', () => doSearch(searchInput.value.trim()));
    searchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        doSearch(searchInput.value.trim());
      }
    });

    // -------------- Init --------------
    (function init() {
      searchMessage.textContent = 'Loading compact book index...';
      initWorkerAndLoadIndex();
      loadSiteDataAndBindEmail();
      window.addEventListener('unload', () => worker?.terminate());
    })();

  })();
  </script>
</body>
</html>
