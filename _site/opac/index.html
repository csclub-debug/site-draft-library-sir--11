<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OPAC (Online Catalog) - Sir M V Library</title>
  <link rel="stylesheet" href="assets/style.css" />
  <style>
    /* Minimal inline safety styles for readability (your main CSS will override) */
    .search-box { display:flex; gap:8px; align-items:center; max-width:900px; }
    #opacSearchInput { flex:1; padding:8px; font-size:15px; }
    #opacSearchBtn { padding:8px 12px; }
    .book-card { margin:6px 0; background:#fff; border-radius:6px; }
    .results-list { display:block; }
    .pagination button { padding:6px 8px; }
    .detail-panel { margin-top:8px; }
  </style>
</head>
<body>
  <section class="section container" style="padding:18px;">
    <h1 style="margin-top:0">Online Public Access Catalog (OPAC)</h1>

    <div class="search-box" style="margin-bottom: 20px;">
      <input id="opacSearchInput" placeholder="Search by Title, Author, ISBN, Publisher, or Accession Number..." autofocus />
      <button id="opacSearchBtn">Search</button>
    </div>

    <div id="search-message">Loading book data...</div>
    <div id="search-results"></div>
  </section>

  <div class="footer-pad"></div>

  <!-- ðŸ”½ Footer updated to match staff.html -->
  <footer class="site-footer" role="contentinfo">
    <div class="inner">
      <div class="footer-top">
        <div class="footer-logo">
          <img src="logo.svg" alt="Library Logo" />
          <div class="footer-info">
            <div class="footer-title">Sir M V Science College Library</div>
            <div class="footer-subtitle">Library & Informatics Centre</div>
          </div>
        </div>
        <div class="footer-contact">
          <a id="footer-email" class="footer-email-btn" href="mailto:library@example.com" aria-label="Email the library">
            library@example.com
          </a>
        </div>
      </div>
      <div class="footer-bottom">
        Sir. M.V. Government Science College, Bommanakatte, Bhadravathi - 577302
      </div>
    </div>
  </footer>
  <!-- ðŸ”¼ End updated footer -->

  <!-- Main script -->
  <script>
  (function () {
    'use strict';

    // ---------- CONFIG ----------
    const INDEX_URL = 'content/books_index.json';            // compact index (lightweight)
    const MAPPING_URL = 'content/accession_to_part.json';   // accession -> chunk filename
    const PARTS_BASE = 'content/';                          // where chunk files live
    const CMS_DATA_URL = 'content/data.json';               // Netlify CMS file for footer.primary_email
    const PER_PAGE = 30;                                    // results per page
    const MIN_SEARCH_CHARS = 3;
    // ----------------------------

    // DOM refs
    const searchInput = document.getElementById('opacSearchInput');
    const searchBtn = document.getElementById('opacSearchBtn');
    const searchResults = document.getElementById('search-results');
    const searchMessage = document.getElementById('search-message');
    const footerEmailLink = document.getElementById('footer-email');

    // App state
    let lastResults = [];
    let currentPage = 1;
    let worker = null;
    let workerReady = false;
    let mapping = null;
    const fetchedPartsCache = {};

    // ---------------- utilities ----------------
    function debounce(fn, wait) {
      let t;
      return function (...args) {
        clearTimeout(t);
        t = setTimeout(() => fn.apply(this, args), wait);
      };
    }

    function escapeHtml(s = '') {
      return String(s)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }
    function escapeAttr(s = '') {
      return String(s).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    }

    // ----------------- CMS footer loader -----------------
    async function loadSiteDataAndBindEmail() {
      try {
        const res = await fetch(CMS_DATA_URL, {cache: 'no-cache'});
        if (!res.ok) throw new Error('content/data.json not found');
        const data = await res.json();

        // The Netlify CMS file structure should include footer.primary_email as per config.yml
        let email = '';
        if (data && typeof data === 'object') {
          if (data.footer && typeof data.footer === 'object' && data.footer.primary_email) {
            email = String(data.footer.primary_email).trim();
          } else if (data.primary_email) {
            email = String(data.primary_email).trim();
          } else if (data.data && data.data.footer && data.data.footer.primary_email) {
            email = String(data.data.footer.primary_email).trim();
          }
        }
        setFooterEmail(email);
      } catch (err) {
        console.warn('Could not load CMS data.json for footer email:', err);
        setFooterEmail('');
      }
    }

    function setFooterEmail(email) {
      if (!footerEmailLink) return;
      if (email) {
        const href = email.indexOf('mailto:') === 0 ? email : 'mailto:' + email;
        footerEmailLink.setAttribute('href', href);
        footerEmailLink.textContent = email;
        footerEmailLink.setAttribute('aria-label', 'Email ' + email);
      } else {
        footerEmailLink.setAttribute('href', 'mailto:library@example.com');
        footerEmailLink.textContent = 'library@example.com';
        footerEmailLink.setAttribute('aria-label', 'Email the library');
      }
    }

    // ---------------- Web Worker (search) ----------------
    function createSearchWorker() {
      const code = `
        self.index = [];
        self.onmessage = async function(e) {
          const msg = e.data;
          if (msg.cmd === 'loadIndex') {
            try {
              const resp = await fetch(msg.url, {cache:'no-cache'});
              const json = await resp.json();
              self.index = json.books || [];
              for (let i=0;i<self.index.length;i++) {
                const b = self.index[i];
                const s = [
                  b.accession_no || '',
                  b.title || '',
                  b.author || '',
                  b.subject || '',
                  b.publisher || '',
                  b.isbn || ''
                ].join(' ');
                b.search = s.toLowerCase();
              }
              self.postMessage({cmd:'loaded', count:self.index.length});
            } catch (err) {
              self.postMessage({cmd:'error', error: String(err)});
            }
          } else if (msg.cmd === 'search') {
            const q = (msg.query || '').trim().toLowerCase();
            if (q.length < (msg.minChars || 3)) {
              self.postMessage({cmd:'too_short', len:q.length});
              return;
            }
            const results = [];
            for (let i=0;i<self.index.length;i++) {
              const b = self.index[i];
              if (b.search && b.search.indexOf(q) !== -1) {
                results.push(b);
              }
            }
            self.postMessage({cmd:'results', results:results, query:q});
          }
        };
      `;
      const blob = new Blob([code], {type: 'application/javascript'});
      return new Worker(URL.createObjectURL(blob));
    }

    function initWorkerAndLoadIndex() {
      worker = createSearchWorker();
      worker.onmessage = function(e) {
        const msg = e.data;
        if (msg.cmd === 'loaded') {
          workerReady = true;
          searchMessage.style.color = '';
          searchMessage.textContent = 'Book index loaded (' + msg.count + ' records). Enter at least ' + MIN_SEARCH_CHARS + ' characters to search.';
        } else if (msg.cmd === 'error') {
          searchMessage.style.color = 'red';
          searchMessage.textContent = 'Failed to load index: ' + msg.error;
          console.error('Worker error', msg.error);
        } else if (msg.cmd === 'too_short') {
          searchMessage.style.color = '';
          searchMessage.textContent = 'Please enter at least ' + MIN_SEARCH_CHARS + ' characters to search.';
          renderResults([]);
        } else if (msg.cmd === 'results') {
          lastResults = msg.results || [];
          currentPage = 1;
          renderResults(lastResults, currentPage);
        }
      };
      worker.postMessage({cmd: 'loadIndex', url: INDEX_URL});
    }

    // ---------------- render & pagination ----------------
    function renderResults(results, page = 1) {
      searchResults.innerHTML = '';
      if (!results || results.length === 0) {
        searchMessage.style.display = 'block';
        searchMessage.textContent = results && results.length === 0 ? 'No books found matching your search term.' : 'Enter a keyword above to start searching.';
        return;
      }
      searchMessage.style.display = 'none';
      const totalPages = Math.ceil(results.length / PER_PAGE);
      const start = (page - 1) * PER_PAGE;
      const end = Math.min(start + PER_PAGE, results.length);
      const slice = results.slice(start, end);

      const container = document.createElement('div');
      container.className = 'results-list';

      for (let b of slice) {
        const c = document.createElement('div');
        c.className = 'book-card';
        c.style.padding = '10px';
        c.style.borderBottom = '1px solid #eee';

        c.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px">
            <div>
              <div style="font-weight:700">${escapeHtml(b.title || 'Untitled')}</div>
              <div style="font-size:13px">Author: ${escapeHtml(b.author || 'N/A')}</div>
              <div style="font-size:13px">Publisher: ${escapeHtml(b.publisher || 'N/A')} ${b.year ? ' â€” ' + escapeHtml(b.year) : ''}</div>
              <div style="font-size:12px;color:#666">Subject: ${escapeHtml(b.subject || 'N/A')}</div>
            </div>
            <div style="text-align:right">
              <div style="font-weight:600">Acc.: ${escapeHtml(b.accession_no || 'N/A')}</div>
              <div style="margin-top:8px">
                <button class="view-btn" data-acc="${escapeAttr(b.accession_no)}">View Details</button>
              </div>
            </div>
          </div>
        `;
        container.appendChild(c);
      }

      searchResults.appendChild(container);

      // pagination
      if (totalPages > 1) {
        const nav = document.createElement('div');
        nav.className = 'pagination';
        nav.style.marginTop = '12px';
        nav.style.display = 'flex';
        nav.style.gap = '8px';
        nav.style.alignItems = 'center';

        const prev = document.createElement('button');
        prev.textContent = 'Previous';
        prev.disabled = page <= 1;
        prev.onclick = () => { currentPage = page - 1; renderResults(results, currentPage); };

        const next = document.createElement('button');
        next.textContent = 'Next';
        next.disabled = page >= totalPages;
        next.onclick = () => { currentPage = page + 1; renderResults(results, currentPage); };

        const info = document.createElement('span');
        info.textContent = `Page ${page} of ${totalPages} â€” ${results.length} results`;

        nav.appendChild(prev);
        nav.appendChild(info);
        nav.appendChild(next);

        searchResults.appendChild(nav);
      }
    }

    // ---------------- actions ----------------
    const doSearch = debounce((q) => {
      if (!workerReady) {
        searchMessage.style.color = '';
        searchMessage.textContent = 'Index still loading...';
        return;
      }
      worker.postMessage({cmd: 'search', query: q, minChars: MIN_SEARCH_CHARS});
    }, 200);

    // events
    searchInput.addEventListener('input', (e) => {
      const q = e.target.value || '';
      if (!q || q.trim() === '') {
        searchMessage.style.display = 'block';
        searchMessage.textContent = 'Enter a keyword above to start searching.';
        renderResults([]);
        return;
      }
      doSearch(q);
    });
    searchBtn.addEventListener('click', () => { doSearch(searchInput.value || ''); });
    searchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); doSearch(searchInput.value || ''); } });

    // ---------------- init ----------------
    (function init() {
      searchMessage.textContent = 'Loading compact book index...';
      initWorkerAndLoadIndex();
      loadSiteDataAndBindEmail();
      window.addEventListener('unload', () => { if (worker) worker.terminate(); });
    })();

  })();
  </script>
</body>
</html>
